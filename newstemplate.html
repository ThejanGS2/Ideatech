<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">News Article - Ideatech (PVT) LTD</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>

    <div id="header-placeholder"></div>

    <main>
        <!-- Loading State -->
        <section id="article-loading" class="article-loading visible">
            <div class="container">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading article...</p>
                </div>
            </div>
        </section>

        <!-- Error State -->
        <section id="article-error" class="article-error" style="display: none;">
            <div class="container">
                <div class="error-state">
                    <h2>Article Not Found</h2>
                    <p>The article you're looking for doesn't exist or has been removed.</p>
                    <a href="news.html" class="btn-primary">Back to News</a>
                </div>
            </div>
        </section>

        <!-- Article Content -->
        <article id="article-content" class="news-article" style="display: none;">
            <div class="container">
                <div class="article-header">
                    <a href="news.html" class="back-link">← Back to News</a>
                    <div class="article-meta" id="article-date"></div>
                    <h1 id="article-title"></h1>
                </div>

                <div class="article-thumbnail" id="article-thumbnail">
                    <!-- Thumbnail will be inserted here -->
                </div>

                <div class="article-body" id="article-description">
                    <!-- Description will be inserted here -->
                </div>

                <div class="article-footer">
                    <a href="news.html" class="btn-primary">← Back to News</a>
                </div>
            </div>
        </article>

    </main>

    <div id="footer-placeholder"></div>

    <script src="components.js"></script>
    <script src="script.js"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@contentful/rich-text-html-renderer@16.0.2/dist/rich-text-html-renderer.es5.min.js"></script>
    <script>
        // Get slug from URL
        function getSlugFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('slug');
        }

        // Fetch article by slug
        async function fetchArticle(slug) {
            const loadingEl = document.getElementById('article-loading');
            const errorEl = document.getElementById('article-error');
            const contentEl = document.getElementById('article-content');

            if (!slug) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(
                    `https://cdn.contentful.com/spaces/${CONFIG.CONTENTFUL.SPACE_ID}/entries?access_token=${CONFIG.CONTENTFUL.ACCESS_TOKEN}&content_type=${CONFIG.CONTENTFUL.CONTENT_TYPE}&fields.slug=${slug}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch article');
                }

                const data = await response.json();

                if (data.items.length === 0) {
                    throw new Error('Article not found');
                }

                // Hide loading, show content
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

                // Display article
                displayArticle(data.items[0], data.includes);

            } catch (error) {
                console.error('Error fetching article:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
            }
        }

        // Display article content
        function displayArticle(item, includes) {
            const fields = item.fields;

            // Update page title
            document.getElementById('page-title').textContent = fields.title ? `${fields.title} - Ideatech` : 'News Article - Ideatech';

            // Display title
            document.getElementById('article-title').textContent = fields.title || 'Untitled';

            // Display date
            if (fields.date) {
                const date = new Date(fields.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('article-date').textContent = date;
            }

            // Display thumbnail
            const thumbnailEl = document.getElementById('article-thumbnail');
            if (fields.thumbnail && fields.thumbnail.sys) {
                const assetId = fields.thumbnail.sys.id;
                const asset = includes.Asset.find(a => a.sys.id === assetId);
                if (asset && asset.fields.file) {
                    const thumbnailUrl = 'https:' + asset.fields.file.url;
                    thumbnailEl.innerHTML = `<img src="${thumbnailUrl}" alt="${fields.title || 'Article thumbnail'}">`;
                } else {
                    thumbnailEl.style.display = 'none';
                }
            } else {
                thumbnailEl.style.display = 'none';
            }

            // Display description (rich text)
            const descriptionEl = document.getElementById('article-description');
            if (fields.description) {
                // Check if the rich-text-html-renderer is available
                if (typeof contentfulRichTextHtmlRenderer !== 'undefined') {
                    const html = contentfulRichTextHtmlRenderer.documentToHtmlString(fields.description);
                    descriptionEl.innerHTML = html;
                } else {
                    // Fallback: display plain text if renderer is not loaded
                    descriptionEl.innerHTML = renderRichTextFallback(fields.description);
                }
            }
        }

        // Fallback function to render rich text as basic HTML
        function renderRichTextFallback(richText) {
            if (!richText || !richText.content) return '';

            let html = '';
            richText.content.forEach(node => {
                if (node.nodeType === 'paragraph') {
                    const text = node.content.map(c => c.value || '').join('');
                    html += `<p>${text}</p>`;
                } else if (node.nodeType === 'heading-1') {
                    const text = node.content.map(c => c.value || '').join('');
                    html += `<h2>${text}</h2>`;
                } else if (node.nodeType === 'heading-2') {
                    const text = node.content.map(c => c.value || '').join('');
                    html += `<h3>${text}</h3>`;
                }
            });
            return html;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const slug = getSlugFromURL();
            fetchArticle(slug);
        });
    </script>

</body>

</html>
